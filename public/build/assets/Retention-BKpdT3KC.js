import{j as e,r as a}from"./app-C2cRDrk6.js";import{C as c,T as k,a as n}from"./client-C_H5CMFT.js";import{B as o}from"./Badge-CbVuks5E.js";import{B as m}from"./Button-Dyjvqw8_.js";/* empty css            */function W({open:i,onClose:u,title:h,children:x,footer:p}){return i?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-slate-900/40",onClick:u}),e.jsx("div",{className:"absolute inset-0 grid place-items-center p-4",children:e.jsxs("div",{className:"w-full max-w-lg bg-white rounded-xl shadow-card",children:[e.jsx("div",{className:"px-5 pt-4 pb-2 border-b",children:e.jsx("h3",{className:"font-semibold",children:h})}),e.jsx("div",{className:"p-5",children:x}),e.jsx("div",{className:"px-5 py-4 border-t flex justify-end gap-2",children:p})]})})]}):null}const F={low:0,medium:0,high:0,critical:0};function V(){const[i,u]=a.useState(F),[h,x]=a.useState([]),[p,N]=a.useState([]),[T,v]=a.useState([]),[g,w]=a.useState(!0),[_,l]=a.useState(null),[E,d]=a.useState(!1),[b,q]=a.useState("Streak Save"),[f,B]=a.useState("no_check_in"),[S,P]=a.useState("sms"),[y,C]=a.useState(""),[R,z]=a.useState(""),[M,I]=a.useState(null);a.useEffect(()=>{let s=!0;async function t(){try{w(!0);const[r,j,D,$]=await Promise.all([n("/retention/heatmap"),n("/retention/at-risk?limit=10"),n("/playbooks"),n("/retention/freeze-requests")]);if(!s)return;u(r.data??F),x(j.data??[]),N(D.data??[]),v($.data??[])}catch(r){if(!s)return;l(r instanceof Error?r.message:"Failed to load retention data")}finally{s&&w(!1)}}return t(),()=>{s=!1}},[]);const L=a.useMemo(()=>s=>s>=70?"High":s>=40?"Med":"Low",[]);async function O(s){s.preventDefault();try{const t={name:b,trigger_type:f,trigger_config:f==="no_check_in"?{days:7}:{},channel_strategy:{primary:S},throttle_rules:{max_per_week:2},quiet_hours:{start:"21:00",end:"08:00"},description:`${b} automation`},r=await n("/playbooks",{method:"POST",body:JSON.stringify(t)});N(j=>[r.data,...j]),d(!1)}catch(t){l(t instanceof Error?t.message:"Failed to create playbook")}}async function H(s){if(s.preventDefault(),l(null),!y){l("Member ID is required for freeze rescue.");return}try{await n(`/retention/members/${y}/freeze-requests`,{method:"POST",body:JSON.stringify({reason:R||void 0})}),C(""),z("");const t=await n("/retention/freeze-requests");v(t.data??[])}catch(t){l(t instanceof Error?t.message:"Failed to log freeze request")}}async function A(){l(null);try{const s=await n("/retention/win-back/run",{method:"POST",body:JSON.stringify({days:30})});I(s.data.triggered)}catch(s){l(s instanceof Error?s.message:"Failed to trigger win-back")}}return e.jsxs("div",{className:"grid gap-6",children:[e.jsx(c,{title:"Churn risk heatmap",subtitle:"Auto-segmented by behavior",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[{label:"Low",count:i.low,tone:"good"},{label:"Med",count:i.medium,tone:"warn"},{label:"High",count:i.high,tone:"bad"},{label:"Critical",count:i.critical,tone:"bad"}].map(s=>e.jsxs("div",{className:"glass p-4",children:[e.jsx("div",{className:"text-sm text-slate-500",children:s.label}),e.jsx("div",{className:"text-2xl font-semibold mt-1",children:s.count}),e.jsx("div",{className:"text-xs text-slate-500",children:"members"})]},s.label))})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsxs(c,{title:"At‑risk roster",subtitle:"Last 14 days",children:[_&&e.jsx("div",{className:"text-sm text-red-600 mb-3",children:_}),e.jsx(k,{cols:[{key:"name",header:"Member"},{key:"lastCheckIn",header:"Last check‑in"},{key:"risk",header:"Risk",render:s=>s==="High"?e.jsx(o,{tone:"bad",children:"High"}):s==="Med"?e.jsx(o,{tone:"warn",children:"Med"}):e.jsx(o,{tone:"good",children:"Low"})},{key:"reason",header:"Reason"}],rows:h.map(s=>{var t,r;return{id:s.member_id,name:s.member.name,lastCheckIn:s.member.last_check_in_days!==null?`${s.member.last_check_in_days} days`:"No check-ins",risk:L(s.score),reason:((r=(t=s.reasons)==null?void 0:t[0])==null?void 0:r.detail)??""}}),loading:g})]}),e.jsxs(c,{title:"Playbooks",subtitle:"Automated interventions",children:[e.jsx(k,{cols:[{key:"name",header:"Name"},{key:"trigger_type",header:"Trigger"},{key:"channel_strategy",header:"Channel",render:s=>{const t=s&&typeof s=="object"?s.primary:null;return e.jsx("span",{className:"text-sm",children:t??"—"})}},{key:"status",header:"Status",render:s=>s==="active"?e.jsx(o,{tone:"good",children:"Active"}):s==="paused"?e.jsx(o,{tone:"warn",children:"Paused"}):e.jsx(o,{children:"Draft"})}],rows:p.map(s=>({...s,channel_strategy:s.channel_strategy??{}})),loading:g}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx(m,{onClick:()=>d(!0),children:"New playbook"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsxs(c,{title:"Freeze rescue",subtitle:"Intercept freeze intent",children:[e.jsxs("form",{className:"grid gap-4",onSubmit:H,children:[e.jsxs("label",{className:"text-sm",children:["Member ID",e.jsx("input",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:y,onChange:s=>C(s.target.value),placeholder:"MEM-123"})]}),e.jsxs("label",{className:"text-sm",children:["Reason",e.jsx("input",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:R,onChange:s=>z(s.target.value),placeholder:"Travel, recovery, etc."})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(m,{type:"submit",children:"Log freeze intent"})})]}),e.jsx(k,{cols:[{key:"member",header:"Member"},{key:"requested_on",header:"Requested"},{key:"status",header:"Status"},{key:"reason",header:"Reason"}],rows:T.map(s=>({id:s.id,member:s.member?`${s.member.first_name} ${s.member.last_name}`:"—",requested_on:s.requested_on,status:s.status,reason:s.reason??"—"})),loading:g})]}),e.jsx(c,{title:"Win-back <30d",subtitle:"Closed members in the last month",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Trigger the Win-back playbook for members who canceled within the past 30 days."}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(m,{type:"button",onClick:A,children:"Run win-back now"}),M!==null&&e.jsxs("span",{className:"text-sm text-slate-600",children:[M," members queued."]})]})]})})]}),e.jsx(W,{open:E,onClose:()=>d(!1),title:"Create playbook",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-4 py-2 rounded-lg text-sm",onClick:()=>d(!1),children:"Cancel"}),e.jsx(m,{type:"submit",form:"playbook-form",children:"Save"})]}),children:e.jsxs("form",{id:"playbook-form",className:"grid gap-4",onSubmit:O,children:[e.jsxs("label",{className:"text-sm",children:["Name",e.jsx("input",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:b,onChange:s=>q(s.target.value),required:!0})]}),e.jsxs("label",{className:"text-sm",children:["Trigger",e.jsxs("select",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:f,onChange:s=>B(s.target.value),children:[e.jsx("option",{value:"no_check_in",children:"7 days no check‑in"}),e.jsx("option",{value:"missed_classes",children:"Missed 2 booked classes"}),e.jsx("option",{value:"cancel_recent",children:"Cancel within 30 days"})]})]}),e.jsxs("label",{className:"text-sm",children:["Channel",e.jsxs("select",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:S,onChange:s=>P(s.target.value),children:[e.jsx("option",{value:"sms",children:"SMS"}),e.jsx("option",{value:"email",children:"Email"})]})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"SMS is convenient but less secure than authenticator apps. Encourage staff to opt into authenticator MFA for higher security when sending sensitive offers."})]})})]})}export{V as default};
