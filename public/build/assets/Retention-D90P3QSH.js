import{r as a,j as s,a as l,i as W}from"./app-CyWvWFcS.js";import{C as o}from"./Card-BhsN8Z8e.js";import{T as p}from"./Table-9gyWEqlH.js";import{B as i}from"./Badge-BPC-gNU6.js";import{M as J}from"./Modal-C5P2Lu4f.js";import{B as m}from"./Button-CUcdcEPx.js";import{T as b}from"./TextInput-s720DIIk.js";import{S as C}from"./SelectInput-Ciu0iF99.js";/* empty css            */const M={low:0,medium:0,high:0,critical:0};function se(){const[c,z]=a.useState(M),[R,T]=a.useState([]),[E,f]=a.useState([]),[F,y]=a.useState([]),[h,j]=a.useState(!0),[k,n]=a.useState(null),[q,d]=a.useState(!1),[u,I]=a.useState("Streak Save"),[x,B]=a.useState("no_check_in"),[v,A]=a.useState("sms"),[g,N]=a.useState(""),[_,S]=a.useState(""),[w,L]=a.useState(null);a.useEffect(()=>{const e=new AbortController;async function t(){try{j(!0);const r=await l("/retention/overview",{signal:e.signal});if(e.signal.aborted)return;z(r.data.heatmap??M),T(r.data.at_risk??[]),f(r.data.playbooks??[]),y(r.data.freeze_requests??[]),n(null)}catch(r){if(W(r)||e.signal.aborted)return;n(r instanceof Error?r.message:"Failed to load retention data")}finally{e.signal.aborted||j(!1)}}return t(),()=>e.abort()},[]);const O=a.useMemo(()=>e=>e>=70?"High":e>=40?"Med":"Low",[]);async function P(e){e.preventDefault();try{const t={name:u,trigger_type:x,trigger_config:x==="no_check_in"?{days:7}:{},channel_strategy:{primary:v},throttle_rules:{max_per_week:2},quiet_hours:{start:"21:00",end:"08:00"},description:`${u} automation`},r=await l("/playbooks",{method:"POST",body:JSON.stringify(t)});f($=>[r.data,...$]),d(!1)}catch(t){n(t instanceof Error?t.message:"Failed to create playbook")}}async function H(e){if(e.preventDefault(),n(null),!g){n("Member ID is required for freeze rescue.");return}try{await l(`/retention/members/${g}/freeze-requests`,{method:"POST",body:JSON.stringify({reason:_||void 0})}),N(""),S("");const t=await l("/retention/overview");y(t.data.freeze_requests??[])}catch(t){n(t instanceof Error?t.message:"Failed to log freeze request")}}async function D(){n(null);try{const e=await l("/retention/win-back/run",{method:"POST",body:JSON.stringify({days:30})});L(e.data.triggered)}catch(e){n(e instanceof Error?e.message:"Failed to trigger win-back")}}return s.jsxs("div",{className:"grid gap-6",children:[s.jsx(o,{title:"Churn risk heatmap",subtitle:"Auto-segmented by behavior",children:s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[{label:"Low",count:c.low,tone:"good"},{label:"Med",count:c.medium,tone:"warn"},{label:"High",count:c.high,tone:"bad"},{label:"Critical",count:c.critical,tone:"bad"}].map(e=>s.jsxs("div",{className:"glass p-4",children:[s.jsx("div",{className:"text-sm text-slate-500",children:e.label}),s.jsx("div",{className:"text-2xl font-semibold mt-1",children:e.count}),s.jsx("div",{className:"text-xs text-slate-500",children:"members"})]},e.label))})}),s.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[s.jsxs(o,{title:"At‑risk roster",subtitle:"Last 14 days",children:[k&&s.jsx("div",{className:"text-sm text-red-600 mb-3",children:k}),s.jsx(p,{cols:[{key:"name",header:"Member"},{key:"lastCheckIn",header:"Last check‑in"},{key:"risk",header:"Risk",render:e=>e==="High"?s.jsx(i,{tone:"bad",children:"High"}):e==="Med"?s.jsx(i,{tone:"warn",children:"Med"}):s.jsx(i,{tone:"good",children:"Low"})},{key:"reason",header:"Reason"}],rows:R.map(e=>{var t,r;return{id:e.member_id,name:e.member.name,lastCheckIn:e.member.last_check_in_days!==null?`${e.member.last_check_in_days} days`:"No check-ins",risk:O(e.score),reason:((r=(t=e.reasons)==null?void 0:t[0])==null?void 0:r.detail)??""}}),loading:h})]}),s.jsxs(o,{title:"Playbooks",subtitle:"Automated interventions",children:[s.jsx(p,{cols:[{key:"name",header:"Name"},{key:"trigger_type",header:"Trigger"},{key:"channel_strategy",header:"Channel",render:e=>{const t=e&&typeof e=="object"?e.primary:null;return s.jsx("span",{className:"text-sm",children:t??"—"})}},{key:"status",header:"Status",render:e=>e==="active"?s.jsx(i,{tone:"good",children:"Active"}):e==="paused"?s.jsx(i,{tone:"warn",children:"Paused"}):s.jsx(i,{children:"Draft"})}],rows:E.map(e=>({...e,channel_strategy:e.channel_strategy??{}})),loading:h}),s.jsx("div",{className:"mt-4 flex justify-end",children:s.jsx(m,{onClick:()=>d(!0),children:"New playbook"})})]})]}),s.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[s.jsxs(o,{title:"Freeze rescue",subtitle:"Intercept freeze intent",children:[s.jsxs("form",{className:"grid gap-4",onSubmit:H,children:[s.jsxs("label",{className:"text-sm",children:["Member ID",s.jsx(b,{className:"mt-1",value:g,onChange:e=>N(e.target.value),placeholder:"MEM-123"})]}),s.jsxs("label",{className:"text-sm",children:["Reason",s.jsx(b,{className:"mt-1",value:_,onChange:e=>S(e.target.value),placeholder:"Travel, recovery, etc."})]}),s.jsx("div",{className:"flex justify-end",children:s.jsx(m,{type:"submit",children:"Log freeze intent"})})]}),s.jsx(p,{cols:[{key:"member",header:"Member"},{key:"requested_on",header:"Requested"},{key:"status",header:"Status"},{key:"reason",header:"Reason"}],rows:F.map(e=>({id:e.id,member:e.member?`${e.member.first_name} ${e.member.last_name}`:"—",requested_on:e.requested_on,status:e.status,reason:e.reason??"—"})),loading:h})]}),s.jsx(o,{title:"Win-back <30d",subtitle:"Closed members in the last month",children:s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsx("p",{className:"text-sm text-slate-600",children:"Trigger the Win-back playbook for members who canceled within the past 30 days."}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(m,{type:"button",onClick:D,children:"Run win-back now"}),w!==null&&s.jsxs("span",{className:"text-sm text-slate-600",children:[w," members queued."]})]})]})})]}),s.jsx(J,{open:q,onClose:()=>d(!1),title:"Create playbook",footer:s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"px-4 py-2 rounded-lg text-sm",onClick:()=>d(!1),children:"Cancel"}),s.jsx(m,{type:"submit",form:"playbook-form",children:"Save"})]}),children:s.jsxs("form",{id:"playbook-form",className:"grid gap-4",onSubmit:P,children:[s.jsxs("label",{className:"text-sm",children:["Name",s.jsx(b,{className:"mt-1",value:u,onChange:e=>I(e.target.value),required:!0})]}),s.jsxs("label",{className:"text-sm",children:["Trigger",s.jsxs(C,{className:"mt-1",value:x,onChange:e=>B(e.target.value),children:[s.jsx("option",{value:"no_check_in",children:"7 days no check‑in"}),s.jsx("option",{value:"missed_classes",children:"Missed 2 booked classes"}),s.jsx("option",{value:"cancel_recent",children:"Cancel within 30 days"})]})]}),s.jsxs("label",{className:"text-sm",children:["Channel",s.jsxs(C,{className:"mt-1",value:v,onChange:e=>A(e.target.value),children:[s.jsx("option",{value:"sms",children:"SMS"}),s.jsx("option",{value:"email",children:"Email"})]})]}),s.jsx("p",{className:"text-xs text-slate-500",children:"SMS is convenient but less secure than authenticator apps. Encourage staff to opt into authenticator MFA for higher security when sending sensitive offers."})]})})]})}export{se as default};
