import{j as e,r as a,a as o,i as D}from"./app-BPwyOtwv.js";import{C as c}from"./Card-CgvE_g0M.js";import{T as j}from"./Table-CbgC9pMU.js";import{B as i}from"./Badge-BLy6uCaQ.js";import{B as u}from"./Button-CvcUjvH4.js";/* empty css            */function $({open:l,onClose:h,title:x,children:g,footer:d}){return l?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-slate-900/60 backdrop-blur-sm",onClick:h}),e.jsx("div",{className:"absolute inset-0 grid place-items-center p-4",children:e.jsxs("div",{className:"w-full max-w-xl overflow-hidden rounded-3xl border border-slate-100 bg-white shadow-2xl",children:[e.jsx("div",{className:"border-b border-slate-100 px-6 pb-3 pt-5",children:e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:x})}),e.jsx("div",{className:"px-6 py-6",children:g}),d&&e.jsx("div",{className:"flex justify-end gap-2 border-t border-slate-100 bg-slate-50/60 px-6 py-4",children:d})]})})]}):null}const R={low:0,medium:0,high:0,critical:0};function V(){const[l,h]=a.useState(R),[x,g]=a.useState([]),[d,k]=a.useState([]),[E,v]=a.useState([]),[p,N]=a.useState(!0),[w,n]=a.useState(null),[F,m]=a.useState(!1),[b,T]=a.useState("Streak Save"),[f,q]=a.useState("no_check_in"),[_,B]=a.useState("sms"),[y,S]=a.useState(""),[C,M]=a.useState(""),[z,A]=a.useState(null);a.useEffect(()=>{const s=new AbortController;async function t(){try{N(!0);const r=await o("/retention/overview",{signal:s.signal});if(s.signal.aborted)return;h(r.data.heatmap??R),g(r.data.at_risk??[]),k(r.data.playbooks??[]),v(r.data.freeze_requests??[]),n(null)}catch(r){if(D(r)||s.signal.aborted)return;n(r instanceof Error?r.message:"Failed to load retention data")}finally{s.signal.aborted||N(!1)}}return t(),()=>s.abort()},[]);const I=a.useMemo(()=>s=>s>=70?"High":s>=40?"Med":"Low",[]);async function L(s){s.preventDefault();try{const t={name:b,trigger_type:f,trigger_config:f==="no_check_in"?{days:7}:{},channel_strategy:{primary:_},throttle_rules:{max_per_week:2},quiet_hours:{start:"21:00",end:"08:00"},description:`${b} automation`},r=await o("/playbooks",{method:"POST",body:JSON.stringify(t)});k(H=>[r.data,...H]),m(!1)}catch(t){n(t instanceof Error?t.message:"Failed to create playbook")}}async function O(s){if(s.preventDefault(),n(null),!y){n("Member ID is required for freeze rescue.");return}try{await o(`/retention/members/${y}/freeze-requests`,{method:"POST",body:JSON.stringify({reason:C||void 0})}),S(""),M("");const t=await o("/retention/overview");v(t.data.freeze_requests??[])}catch(t){n(t instanceof Error?t.message:"Failed to log freeze request")}}async function P(){n(null);try{const s=await o("/retention/win-back/run",{method:"POST",body:JSON.stringify({days:30})});A(s.data.triggered)}catch(s){n(s instanceof Error?s.message:"Failed to trigger win-back")}}return e.jsxs("div",{className:"grid gap-6",children:[e.jsx(c,{title:"Churn risk heatmap",subtitle:"Auto-segmented by behavior",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[{label:"Low",count:l.low,tone:"good"},{label:"Med",count:l.medium,tone:"warn"},{label:"High",count:l.high,tone:"bad"},{label:"Critical",count:l.critical,tone:"bad"}].map(s=>e.jsxs("div",{className:"glass p-4",children:[e.jsx("div",{className:"text-sm text-slate-500",children:s.label}),e.jsx("div",{className:"text-2xl font-semibold mt-1",children:s.count}),e.jsx("div",{className:"text-xs text-slate-500",children:"members"})]},s.label))})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsxs(c,{title:"At‑risk roster",subtitle:"Last 14 days",children:[w&&e.jsx("div",{className:"text-sm text-red-600 mb-3",children:w}),e.jsx(j,{cols:[{key:"name",header:"Member"},{key:"lastCheckIn",header:"Last check‑in"},{key:"risk",header:"Risk",render:s=>s==="High"?e.jsx(i,{tone:"bad",children:"High"}):s==="Med"?e.jsx(i,{tone:"warn",children:"Med"}):e.jsx(i,{tone:"good",children:"Low"})},{key:"reason",header:"Reason"}],rows:x.map(s=>{var t,r;return{id:s.member_id,name:s.member.name,lastCheckIn:s.member.last_check_in_days!==null?`${s.member.last_check_in_days} days`:"No check-ins",risk:I(s.score),reason:((r=(t=s.reasons)==null?void 0:t[0])==null?void 0:r.detail)??""}}),loading:p})]}),e.jsxs(c,{title:"Playbooks",subtitle:"Automated interventions",children:[e.jsx(j,{cols:[{key:"name",header:"Name"},{key:"trigger_type",header:"Trigger"},{key:"channel_strategy",header:"Channel",render:s=>{const t=s&&typeof s=="object"?s.primary:null;return e.jsx("span",{className:"text-sm",children:t??"—"})}},{key:"status",header:"Status",render:s=>s==="active"?e.jsx(i,{tone:"good",children:"Active"}):s==="paused"?e.jsx(i,{tone:"warn",children:"Paused"}):e.jsx(i,{children:"Draft"})}],rows:d.map(s=>({...s,channel_strategy:s.channel_strategy??{}})),loading:p}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx(u,{onClick:()=>m(!0),children:"New playbook"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsxs(c,{title:"Freeze rescue",subtitle:"Intercept freeze intent",children:[e.jsxs("form",{className:"grid gap-4",onSubmit:O,children:[e.jsxs("label",{className:"text-sm",children:["Member ID",e.jsx("input",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:y,onChange:s=>S(s.target.value),placeholder:"MEM-123"})]}),e.jsxs("label",{className:"text-sm",children:["Reason",e.jsx("input",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:C,onChange:s=>M(s.target.value),placeholder:"Travel, recovery, etc."})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(u,{type:"submit",children:"Log freeze intent"})})]}),e.jsx(j,{cols:[{key:"member",header:"Member"},{key:"requested_on",header:"Requested"},{key:"status",header:"Status"},{key:"reason",header:"Reason"}],rows:E.map(s=>({id:s.id,member:s.member?`${s.member.first_name} ${s.member.last_name}`:"—",requested_on:s.requested_on,status:s.status,reason:s.reason??"—"})),loading:p})]}),e.jsx(c,{title:"Win-back <30d",subtitle:"Closed members in the last month",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Trigger the Win-back playbook for members who canceled within the past 30 days."}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{type:"button",onClick:P,children:"Run win-back now"}),z!==null&&e.jsxs("span",{className:"text-sm text-slate-600",children:[z," members queued."]})]})]})})]}),e.jsx($,{open:F,onClose:()=>m(!1),title:"Create playbook",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-4 py-2 rounded-lg text-sm",onClick:()=>m(!1),children:"Cancel"}),e.jsx(u,{type:"submit",form:"playbook-form",children:"Save"})]}),children:e.jsxs("form",{id:"playbook-form",className:"grid gap-4",onSubmit:L,children:[e.jsxs("label",{className:"text-sm",children:["Name",e.jsx("input",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:b,onChange:s=>T(s.target.value),required:!0})]}),e.jsxs("label",{className:"text-sm",children:["Trigger",e.jsxs("select",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:f,onChange:s=>q(s.target.value),children:[e.jsx("option",{value:"no_check_in",children:"7 days no check‑in"}),e.jsx("option",{value:"missed_classes",children:"Missed 2 booked classes"}),e.jsx("option",{value:"cancel_recent",children:"Cancel within 30 days"})]})]}),e.jsxs("label",{className:"text-sm",children:["Channel",e.jsxs("select",{className:"mt-1 w-full border rounded-lg px-3 py-2",value:_,onChange:s=>B(s.target.value),children:[e.jsx("option",{value:"sms",children:"SMS"}),e.jsx("option",{value:"email",children:"Email"})]})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"SMS is convenient but less secure than authenticator apps. Encourage staff to opt into authenticator MFA for higher security when sending sensitive offers."})]})})]})}export{V as default};
